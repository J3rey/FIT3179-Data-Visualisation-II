<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>
      Which demographic group is currently the most prominent in the Olympics?
    </title>

    <!-- Use the same library versions as the working choropleth page -->
    <script src="https://cdn.jsdelivr.net/npm/vega@5.22.1"></script>
    <script src="https://cdn.jsdelivr.net/npm/vega-lite@5.5.0"></script>
    <script src="https://cdn.jsdelivr.net/npm/vega-embed@6.21.0"></script>

    <style>
      :root {
        --max-width: 1100px;
      }

      html,
      body {
        margin: 0;
        padding: 0;
        background: #ffffff;
        color: #111111;
        font-family: system-ui, -apple-system, Segoe UI, Roboto, Helvetica,
          Arial, sans-serif;
        line-height: 1.45;
      }

      header {
        max-width: var(--max-width);
        margin: 24px auto 8px auto;
        padding: 0 16px;
        text-align: centre;
      }

      header h1 {
        margin: 0 0 6px 0;
        font-size: clamp(20px, 3.5vw, 32px);
        font-weight: 700;
        letter-spacing: 0.3px;
      }

      /* Poster layout */
      .poster {
        max-width: var(--max-width);
        margin: 0 auto 48px auto;
        padding: 8px 16px 32px 16px;
        display: flex;
        flex-direction: column;
        gap: 28px;
      }

      section.chart-block {
        display: flex;
        flex-direction: column;
        gap: 10px;
      }

      .chart-title {
        font-size: clamp(16px, 2.4vw, 20px);
        font-weight: 600;
        letter-spacing: 0.2px;
        margin: 0;
      }

      /* Chart host, no initial horizontal scroll, no blur */
      .vis {
        width: 100%;
        overflow: visible;
        border: 1px solid #eee;
        border-radius: 10px;
        padding: 10px;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.04);
        background: #fff;
      }

      .vega-embed,
      .vega-embed > canvas,
      .vega-embed > svg {
        display: block;
        max-width: none;
      }

      footer {
        max-width: var(--max-width);
        margin: 16px auto 40px auto;
        padding: 0 16px;
        font-size: 12px;
        opacity: 0.65;
        text-align: centre;
      }
    </style>
  </head>

  <body>
    <header>
      <h1>
        Which demographic group is currently the most prominent in the Olympics?
      </h1>
    </header>

    <main class="poster">
      <section class="chart-block">
        <h2 class="chart-title" id="title-butterfly">
          Athlete Age Distribution by Gender in Paris 2024 Summer Olympics
        </h2>
        <div class="vis" id="chart-butterfly"></div>
      </section>

      <section class="chart-block">
        <h2 class="chart-title" id="title-choropleth">
          Country Participation in 2024 Summer Paris Olympics
        </h2>
        <div class="vis" id="chart-choropleth"></div>
      </section>

      <section class="chart-block">
        <h2 class="chart-title" id="title-stacked">
          Medal Distribution in Paris 2024 Summer Olympics
        </h2>
        <div class="vis" id="chart-stacked"></div>
      </section>

      <section class="chart-block">
        <h2 class="chart-title" id="title-pictorial">
          Athlete Gender Comparison in Paris 2024 Summer Olympics
        </h2>
        <div class="vis" id="chart-pictorial"></div>
      </section>

      <section class="chart-block">
        <h2 class="chart-title" id="title-pie">
          Top 8 Countries' Attendance Over Years in Olympics
        </h2>
        <div class="vis" id="chart-pie"></div>
      </section>
    </main>

    <script>
      // Crisp defaults for non map charts
      const defaultOpts = { renderer: "canvas", actions: false, tooltip: true };

      const charts = [
        {
          el: "#chart-butterfly",
          file: "./js/butterfly_chart.json",
          kind: "other",
          titleEl: "#title-butterfly",
        },
        {
          el: "#chart-stacked",
          file: "./js/horizontal_stacked_bar_chart.json",
          kind: "other",
          titleEl: "#title-stacked",
        },
        {
          el: "#chart-pictorial",
          file: "./js/pictorial_chart.json",
          kind: "other",
          titleEl: "#title-pictorial",
        },
        {
          el: "#chart-pie",
          file: "./js/pie_chart_years.json",
          kind: "other",
          titleEl: "#title-pie",
        },
        {
          el: "#chart-choropleth",
          file: "./js/chloropleth_map.json",
          kind: "choropleth",
          titleEl: "#title-choropleth",
        }, // embed last
      ];

      // Wait for layout and fonts so width is stable
      async function whenReadyForLayout() {
        if (document.fonts && document.fonts.ready) {
          try {
            await document.fonts.ready;
          } catch {}
        }
        // two RAF ticks to be safe
        await new Promise((r) =>
          requestAnimationFrame(() => requestAnimationFrame(r))
        );
      }

      function boxWidth(el) {
        const rect = el.getBoundingClientRect();
        const w = Math.max(
          320,
          Math.floor(rect.width || el.clientWidth || window.innerWidth)
        );
        return w;
      }

      async function embedChart({ el, file, kind, titleEl }) {
        const host = document.querySelector(el);
        try {
          const res = await fetch(file);
          const spec = await res.json();

          // surface title if present
          try {
            const t = document.querySelector(titleEl);
            if (spec && spec.title) {
              t.textContent =
                typeof spec.title === "string"
                  ? spec.title
                  : spec.title.text || t.textContent;
            }
          } catch {}

          await whenReadyForLayout();

          let view;
          if (kind === "choropleth") {
            // Set a real numeric width and height before embedding
            const w = boxWidth(host);
            const h = Math.round(w * 0.55); // nice map aspect

            // Make a shallow copy so we do not mutate your file on other pages
            const mapSpec = Object.assign({}, spec, {
              width: w,
              height: h,
              autosize: { type: "pad", contains: "padding" }, // avoid fit-on-zero issues
            });

            view = await vegaEmbed(el, mapSpec); // default options work best for maps

            // Keep it responsive
            const ro = new ResizeObserver(() => {
              try {
                const newW = boxWidth(host);
                const newH = Math.round(newW * 0.55);
                view.view.width(newW).height(newH).resize().runAsync();
              } catch {}
            });
            ro.observe(host);
          } else {
            // Non map charts, simple embed with crisp defaults
            view = await vegaEmbed(el, spec, defaultOpts);

            const ro = new ResizeObserver(() => {
              try {
                const newW = boxWidth(host);
                view.view.width(newW).resize().runAsync();
              } catch {}
            });
            ro.observe(host);
          }
        } catch (e) {
          host.innerHTML =
            "<p style='margin:0;padding:6px;font-size:14px;color:#b00020;'>Could not load " +
            file +
            "</p>";
          console.error("Embed error for", file, e);
        }
      }

      // Embed after the page has fully laid out
      window.addEventListener("load", () => {
        charts.forEach(embedChart);
      });
    </script>
  </body>
</html>
